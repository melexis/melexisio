<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Melexis.IO DFU</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <style>
        :root {
            color-scheme: light dark;
            --theme-green: #00ADEF;
            --bg-green: #1A2027;
            --text-on-green: #E9F2FF;
            --panel-bg: #232A34;
            --panel-border: #2D3742;
            --muted-on-green: #A9B8C9;
        }
        body { font-family:'Montserrat',Arial,sans-serif; margin:0; background:var(--bg-green); color:var(--text-on-green); min-height:100vh; display:flex; flex-direction:column; }
        header { display:flex; align-items:center; justify-content:center; padding:.75rem 1rem; border-bottom:1px solid var(--panel-border); background:var(--panel-bg); }
        header img { max-height:72px; height:auto; width:auto; }
        main { flex:1 1 auto; padding:1rem; max-width:1100px; width:100%; margin:0 auto; }
        fieldset { background:var(--panel-bg); border:1px solid var(--panel-border); border-radius:.75rem; padding:1rem 1.25rem; }
        legend { padding:0 .5rem; font-weight:600; }
        .muted { color:var(--muted-on-green); font-size:.75rem; }
        #log { white-space:pre-wrap; font:12px ui-monospace,Consolas,monospace; background:#000; color:#cfe2ff; padding:.75rem; height:260px; overflow:auto; border:1px solid var(--panel-border); border-radius:.5rem; }
        .progress { height:10px; background:#0d1a2b; border:1px solid var(--panel-border); border-radius:4px; overflow:hidden; }
        .progress span { display:block; height:100%; background:#3b82f6; width:0%; transition:width .15s linear; }
        .btn-primary { background-color: var(--theme-green); border-color: var(--theme-green); }
        .btn-primary:hover, .btn-primary:focus { background-color:#008ec1; border-color:#008ec1; }
        .btn-outline-secondary { color:#E3ECFA; border-color:#88A8C7; }
        .btn-outline-secondary:hover { background:#88A8C7; color:#0E203C; }
        .btn-outline-danger { color:#ffc8c8; border-color:#ff7a7a; }
        .btn-outline-danger:hover { background:#ff7a7a; color:#300; }
        .btn-outline-info { color:#c2ecff; border-color:#74d2ff; }
        .btn-outline-info:hover { background:#74d2ff; color:#002a38; }
        .panel { background:var(--panel-bg); border:1px solid var(--panel-border); border-radius:.75rem; padding:1rem 1.25rem; margin-bottom:1rem; }
        label { font-size:.85rem; }
    </style>
</head>
<body>
    <header><img src="../media/banner.png" alt="Melexis.IO" /></header>
    <main>
        <h4 class="mb-3">STM32 DFU Firmware Update</h4>
        <div class="panel mb-3">
            <div class="row g-3">
                <div class="col-12 col-md-4">
                    <label class="form-label w-100">Firmware file (.dfu/.bin optional)
                        <input type="file" id="fw" accept=".bin,.dfu" class="form-control form-control-sm" />
                    </label>
                </div>
                <div class="col-6 col-md-4">
                    <label class="form-label w-100">Transfer size
                        <input id="xfer" type="number" value="1024" min="64" max="4096" class="form-control form-control-sm" />
                    </label>
                </div>
                <div class="col-6 col-md-4">
                    <label class="form-label w-100">Base address (hex)
                        <input id="base" value="08000000" class="form-control form-control-sm" />
                    </label>
                </div>
            </div>
            <div class="d-flex flex-wrap gap-2 mt-3">
                <button id="connect" class="btn btn-primary btn-sm">Connect DFU Device</button>
                <button id="flash" class="btn btn-outline-info btn-sm" disabled>Flash Firmware</button>
                <button id="abort" class="btn btn-outline-danger btn-sm" disabled>Abort</button>
                <button id="leave" class="btn btn-outline-secondary btn-sm" disabled>Leave DFU</button>
            </div>
            <div class="progress mt-3"><span id="bar"></span></div>
            <div id="log" class="mt-3" aria-live="polite"></div>
            <div class="muted mt-2">If no file selected, auto loads <code>/bin/melexis_io_fw.dfu</code>.</div>
        </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

<script>
/*
Minimal WebUSB DFU helper for STM32 (DFU class 0xFE/0x01/0x02).
Tested in Chromium-based browsers. Device must already expose DFU interface.
For ST DFU (DfuSe), we inject a Set Address command (0x21) if base address provided.
This is a simplified example; production code should add more validation.
*/
const DFU = {
    DETACH:0, DNLOAD:1, UPLOAD:2, GETSTATUS:3,
    CLRSTATUS:4, GETSTATE:5, ABORT:6
};
let device, dfuInterface = null, altSetting = 0, transferSize = 1024;
// Auto firmware URL (root-relative so page can be served from site root)
const AUTO_FIRMWARE_URL = '/bin/melexis_io_fw.dfu';
let autoFirmwareCache = null; // { bytes: Uint8Array, name: string }

async function fetchAutoFirmware() {
    if (autoFirmwareCache) return autoFirmwareCache;
    try {
        const resp = await fetch(AUTO_FIRMWARE_URL, { cache: 'no-store' });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const buf = await resp.arrayBuffer();
        const bytes = new Uint8Array(buf);
        autoFirmwareCache = { bytes, name: AUTO_FIRMWARE_URL.split('/').pop() || 'firmware.dfu' };
        log('Auto firmware loaded: ' + autoFirmwareCache.name + ' (' + bytes.length + ' bytes)');
        return autoFirmwareCache;
    } catch (e) {
        log('Auto firmware fetch failed: ' + e.message);
        return null;
    }
}

function log(msg){
    const box = document.getElementById('log');
    box.textContent += msg + "\n";
    box.scrollTop = box.scrollHeight;
}

async function connect(){
    const filters = [
        // STMicroelectronics (0483), class DFU optional
        { vendorId: 0x0483 },
        // Add other vendor IDs if needed
    ];
    device = await navigator.usb.requestDevice({ filters });
    await device.open();
    if (device.configuration === null) await device.selectConfiguration(1);
    // Find DFU interface
    for (const iface of device.configuration.interfaces){
        for (const alt of iface.alternates){
            if (alt.interfaceClass === 0xFE && alt.interfaceSubclass === 0x01 && alt.interfaceProtocol === 0x02){
                dfuInterface = iface.interfaceNumber;
                altSetting = alt.alternateSetting;
                break;
            }
        }
        if (dfuInterface !== null) break;
    }
    if (dfuInterface === null){ log("DFU interface not found."); return; }
    await device.claimInterface(dfuInterface);
    await device.selectAlternateInterface(dfuInterface, altSetting);
    log("Connected. Interface: " + dfuInterface + " Alt: " + altSetting);
    document.getElementById('flash').disabled = false;
    document.getElementById('abort').disabled = false;
    document.getElementById('leave').disabled = false;
}

async function control(request, value=0, index=altSetting, length=0){
    return device.controlTransferOut({
        requestType:'class',
        recipient:'interface',
        request,
        value,
        index
    }, new ArrayBuffer(length));
}

async function dnload(blockNum, data){
    return device.controlTransferOut({
        requestType:'class',
        recipient:'interface',
        request: DFU.DNLOAD,
        value: blockNum,
        index: dfuInterface
    }, data);
}

async function getStatus(){
    const r = await device.controlTransferIn({
        requestType:'class',
        recipient:'interface',
        request: DFU.GETSTATUS,
        value:0,
        index: dfuInterface
    }, 6);
    if (!r.data) throw new Error("No status data");
    return {
        status: r.data.getUint8(0),
        pollTimeout: r.data.getUint8(1) | (r.data.getUint8(2)<<8) | (r.data.getUint8(3)<<16),
        state: r.data.getUint8(4),
        iString: r.data.getUint8(5)
    };
}

function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

async function waitState(target){
    for (let i=0;i<50;i++){
        const s = await getStatus();
        if (s.state === target) return s;
        if (s.state === 5) await sleep(s.pollTimeout); // dfuDNLOAD_BUSY
        else if (s.state === 2 || s.state === 9) await sleep(10); // dfuIDLE/dfuMANIFEST
        else log("State: "+s.state+" Status: "+s.status);
    }
    throw new Error("Timeout waiting for state " + target);
}

function makeSetAddressCommand(addrHex){
    const addr = parseInt(addrHex,16) >>> 0;
    // ST DfuSe SET ADDRESS POINTER command: 0x21 followed by 4 little-endian bytes
    const buf = new Uint8Array(5);
    buf[0] = 0x21;
    buf[1] = addr & 0xFF;
    buf[2] = (addr>>8)&0xFF;
    buf[3] = (addr>>16)&0xFF;
    buf[4] = (addr>>24)&0xFF;
    return buf;
}

async function flash(){
    // Prefer user-selected file; fall back to bundled auto firmware.
    let file = document.getElementById('fw').files[0];
    let fw;
    let sourceLabel;
    if (file) {
        const arrayBuf = await file.arrayBuffer();
        fw = new Uint8Array(arrayBuf);
        sourceLabel = 'user file ' + file.name;
    } else {
        const autoFw = await fetchAutoFirmware();
        if (!autoFw) { log('No firmware file selected and auto firmware missing.'); return; }
        fw = autoFw.bytes;
        sourceLabel = 'auto firmware ' + autoFw.name;
    }
    transferSize = parseInt(document.getElementById('xfer').value,10);
    const baseAddr = document.getElementById('base').value.trim();
    log('Using ' + sourceLabel + ' (' + fw.length + ' bytes)');
    let blockNum = 0;
    // Optional address command for ST DFU
    if (baseAddr){
        log("Sending Set Address Pointer: 0x"+baseAddr);
        await dnload(blockNum++, makeSetAddressCommand(baseAddr));
        await waitState(2); // dfuIDLE
    }
    const total = fw.length;
    let offset = 0;
    while (offset < total){
        const chunkSize = Math.min(transferSize, total - offset);
        const chunk = fw.slice(offset, offset + chunkSize);
        await dnload(blockNum++, chunk);
        const st = await getStatus();
        if (st.state === 5) await sleep(st.pollTimeout); // busy
        await waitState(2); // back to idle
        offset += chunkSize;
        updateProgress(offset/total*100);
        if (offset % (transferSize*8) === 0) log(`Progress ${((offset/total)*100).toFixed(1)}%`);
    }
    // Send zero-length to signal end
    await dnload(blockNum, new Uint8Array());
    log("Manifesting...");
    await waitManifest();
    log("Done.");
}

async function waitManifest(){
    for(;;){
        const s = await getStatus();
        if (s.state === 8){ // dfuMANIFEST_SYNC
            await sleep(s.pollTimeout);
        } else if (s.state === 9){ // dfuMANIFEST
            await sleep(10);
        } else if (s.state === 10 || s.state === 2){ // dfuMANIFEST_WAIT_RESET / idle (wDetach)
            break;
        } else {
            await sleep(10);
        }
    }
}

async function leave(){
    log("Sending DETACH");
    await control(DFU.DETACH, 1000, dfuInterface);
    log("Device should reset into application.");
}

async function abort(){
    log("ABORT");
    await control(DFU.ABORT,0,dfuInterface);
}

function updateProgress(p){
    document.getElementById('bar').style.width = p.toFixed(2)+'%';
}

document.getElementById('connect').onclick = ()=>connect().catch(e=>log("Err: "+e.message));
document.getElementById('flash').onclick = ()=>flash().catch(e=>log("Flash error: "+e.message));
document.getElementById('abort').onclick = ()=>abort().catch(e=>log("Abort error: "+e.message));
document.getElementById('leave').onclick = ()=>leave().catch(e=>log("Leave error: "+e.message));

// Feature detection
if (!('usb' in navigator)){
    log("WebUSB not supported in this browser.");
}
</script>
</body>
</html>